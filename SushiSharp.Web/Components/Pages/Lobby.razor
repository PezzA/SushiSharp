@page "/lobby"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.AspNetCore.Authorization
@using Newtonsoft.Json
@using SushiSharp.Cards
@using SushiSharp.Game
@using SushiSharp.Game.Chat
@using SushiSharp.Game.Models
@using SushiSharp.Web.Components.Sushi.Game
@using SushiSharp.Web.Components.Sushi.Lobby
@using Tableau = SushiSharp.Cards.Tableau
@implements IAsyncDisposable

@attribute [Authorize]

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JsRuntime
@inject ISnackbar Snackbar

@if (_publicVisible != null)
{
    switch (_publicVisible.Status)
    {
        case GameStatus.SettingUp:
            <Setup
                GameState="_publicVisible"
                LeaveGame="LeaveGame"
                StartGame="StartGame"/>
            break;
        case GameStatus.Running:
            <Tableau
                SubmitTurn="SubmitTurn"
                GameState="_publicVisible"
                PlayerState="_playerVisible"
                ViewerState="_viewerVisible"
                TurnState="_turnStatus"/>
            break;
        case GameStatus.Results:
            <Results
                GameState="_publicVisible"/>
            break;
        default:
            throw new InvalidDataException("Unknown game state");
    }
}
else
{
    <GameLobby
        Games="_gameList"
        Messages="_messages"
        SendChatMessage="Send"
        JoinGame="JoinGame"
        CreateGame="CreateGame"/>
}

@code {
    private HubConnection? _hubConnection;

    // Each private here represents a separately maintainable facet of client state
    private List<ChatMessage>? _messages = [];
    private List<PublicVisible> _gameList = [];
    
    private PublicVisible? _publicVisible;
    private ViewerVisible? _viewerVisible;
    private PlayerVisible? _playerVisible;
    private Dictionary<string, bool>? _turnStatus = [];

    private async Task Debug(string message)
    {
        await JsRuntime.InvokeAsync<string>("console.log", message);
    }
    
    private void Toast(string message, Severity severity)
    {
        Snackbar.Add(message, severity);
    }

    protected override async Task OnInitializedAsync()
    {
        if (_hubConnection != null) return;

        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/lobbyhub"))
            .Build();

        _hubConnection.On(ServerMessages.GameList, async (string message) =>
        {
            await Debug($"{ServerMessages.GameList}: {message}");

            _gameList = string.IsNullOrEmpty(message)
                ? []
                : JsonConvert.DeserializeObject<PublicVisible[]>(message)!.ToList();

            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On(ServerMessages.LobbyChat, async (string message) =>
        {
            await Debug($"{ServerMessages.LobbyChat}: {message}");

            _messages = string.IsNullOrEmpty(message)
                ? []
                : JsonConvert.DeserializeObject<List<ChatMessage>>(message);
            
            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On(ServerMessages.ErrorMessage, async (string message) =>
        {
            Toast(message, Severity.Warning);
            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On(ServerMessages.SetPlayerTurnStatus, async (string message) =>
        {
            await Debug($"{ServerMessages.SetPlayerTurnStatus}: {message}");

            _turnStatus = string.IsNullOrEmpty(message)
                ? []
                : JsonConvert.DeserializeObject<Dictionary<string, bool>>(message);
            
            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On(ServerMessages.SetViewerVisibleData, async (string message) =>
        {
            await Debug($"{ServerMessages.SetViewerVisibleData}: {message}");

            _viewerVisible = string.IsNullOrEmpty(message)
                ? null
                : JsonConvert.DeserializeObject<ViewerVisible>(message);
            
            await InvokeAsync(StateHasChanged);
        });
        
        _hubConnection.On(ServerMessages.SetPlayerVisibleData, async (string message) =>
        {
            await Debug($"{ServerMessages.SetPlayerVisibleData}: {message}");

             _playerVisible = string.IsNullOrEmpty(message)
                ? null
                : JsonConvert.DeserializeObject<PlayerVisible>(message);
            
            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On(ServerMessages.SetPlayerGame, async (string message) =>
        {
            await Debug($"{ServerMessages.SetPlayerGame}: {message}");

            _publicVisible = string.IsNullOrEmpty(message)
                ? null
                : JsonConvert.DeserializeObject<PublicVisible>(message);
            
            await InvokeAsync(StateHasChanged);
        });

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        await _hubConnection.StartAsync();
        await _hubConnection.SendAsync(ClientMessage.InitClient, authState.User.Identity?.Name);
    }

    private async Task StartGame(string gameId)
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.SendAsync(ClientMessage.StartGame, gameId);
        }
    }

    private async Task JoinGame(string gameId)
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.SendAsync(ClientMessage.JoinGame, gameId);
        }
    }

    private async Task CreateGame()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.SendAsync(ClientMessage.CreateGame);
        }
    }

    private async Task Send(string message)
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.SendAsync(ClientMessage.SendLobbyChat, message);
        }
    }

    private async Task SubmitTurn(Sushi.Game.Tableau.SubmitTurnArgs args)
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.SendAsync(ClientMessage.SubmitTurn, args.GameId, JsonConvert.SerializeObject(args.Cards));
        }
    }
    private async Task LeaveGame(string gameId)
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.SendAsync(ClientMessage.LeaveGame, gameId);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }

}